<h1>Введение</h1><p>Общая документация по ЯД:&nbsp;<a href="https://docs.uiscom.ru/pages/viewpage.action?pageId=171324534">https://docs.uiscom.ru/pages/viewpage.action?pageId=171324534</a></p><p>Документация по модулю достоверности:&nbsp;<a href="https://docs.uiscom.ru/pages/viewpage.action?pageId=169524426">https://docs.uiscom.ru/pages/viewpage.action?pageId=169524426</a></p><p>Общая концепция состоит в периодическом получении данных из Яндекс Директ (<a href="https://direct.yandex.ru/">https://direct.yandex.ru/</a>) с использованием API (<a href="https://yandex.ru/dev/direct/doc/dg/concepts/overview.html">https://yandex.ru/dev/direct/doc/dg/concepts/overview.html</a>), некотором их преобразовании и сохранении в Смартис для последующего использования в аналитических отчетах. Механизм реализован посредствам периодического запуска последовательности синхронизаций, в которые передаются параметры, содержащиеся в интеграциях. Т.е. одна синхронизация может получать данные по нескольким интеграциям. При запуске синхронизации без параметров, будут получены данные по всем интеграциям за период по умолчанию, определенный в синхронизации. Как правило, важна последовательность запуска синхронизаций</p><h1>Термины и определения</h1><p>Интеграция &ndash; Сущность, содержащая параметры синхронизации в привязки к клиенту и его ЛК. У одного клиента может быть множество интеграций.</p><p>Синхронизация (или синхрон) &ndash; Получение данных из внешнего источника. Синхронизация может быть запущена для одной или множества интеграций.</p><p>Достоверность - соответствие данных в БД Smartis и данных в API интеграции. Хорошая достоверность по ЯД - 99% и выше.</p><h1>Общие сведения</h1><p>Общая последовательность загрузки данных:</p><ul><li>Синхроны загрузки сущностей верхнего уровня (аккаунты, компании, группы)</li><li>Синхроны планирования загрузки объемных данных (объявления, расходы, ключевые слова)</li><li>Синхроны загрузки объемных данных (объявления, расходы, ключевые слова)</li><li>Синхрон расчета достоверности</li></ul><h1>Автоматический и ручной запуск синхронов</h1><h2>Автоматический запуск</h2><p><br /></p><h2>Ручной запуск</h2><p>Ручной запуск синхрона осуществляется командой artsan synchronization:run (класс App\Console\Commands\SynchronizationCommand). Обязательным параметром является идентификатор синхрона.</p><h1>Синхронизация расходов</h1><p>Регулярно запускается синхрон 362 (YDirectInsights: Создание плана). Он создает&nbsp; записи в таблице smartis_stat.YDirect_insights_plan для всех планируемых к запуску интеграций с параметрами их запуска.</p><p>Далее выполняется регулярный запуск синхрона 345 (YDirectInsights: Создание плана для получения расходов директа в MySql). Он получает список запланированных интеграций из таблицы smartis_stat.YDirect_insights_plan и ставит в очередь задание по каждой интеграции. Задание (App\Jobs\YDirect\YDirectInsightsToMySqlJob) запрашивает данные через Api Яндекс Директ и помещает их в промежуточную таблицу smartis_stat.YDirect_insights_new.</p><p>Далее выполняется регулярный запуск синхрона 346 (YDirectInsights: Создание плана для сохранения расходов директа в ClickHouse). Он получает список запланированных интеграций (для которых выполнен синхрон 345) из таблицы smartis_stat.YDirect_insights_plan и ставит в очередь задание по каждой интеграции. Задание (App\Jobs\YDirect\YDirectInsightsToClickHouseJob) запрашивает данные из промежуточной таблицы smartis_stat.YDirect_insights_new, обогащает их дополнительными данными и помещает результат в общую таблицу расходов Clickhouse smartcallback_ch2.insights_ch1. В конце выполнения задачи в таблицу smartis_stat.accuracy_plan помещается информация о необходимости запуска синхрона 65 и перерасчета достоверности для интеграции.</p><p>Регулярный запуск синхрона 65 (Accuracy: основной синхрон заполнения itogs) обеспечивает перерасчет достоверности на основе планов из таблицы smartis_stat.accuracy_plan и помещение результатов в таблицу smartis_stat.accuracy_itogs.</p><h1>Синхронизации</h1><p>Список синхронизаций, реализующие их классы и глобальные параметры их запуска см. таблицу synchronizations.synchronization_items</p><table class="wrapped"><tbody><tr class="xtr-0"><td class="xtd-0-0"><p>SELECT *</p><p>FROM synchronizations.synchronization_items</p><p>WHERE TRUE</p><p>&nbsp;AND synchronization_items.is_active = 1</p><p>&nbsp;AND synchronization_items.service_id = 1</p><p>ORDER BY synchronization_items.title;</p></td></tr></tbody></table><p><br /></p><p><br /></p><table class="wrapped"><tbody><tr class="xtr-0"><td class="xtd-0-0"><p><strong>id</strong></p></td><td class="xtd-0-1"><p><strong>Title</strong></p></td><td class="xtd-0-2"><p><strong>class_name</strong></p></td><td class="xtd-0-3"><p><strong>Параметры по умолчанию</strong></p></td></tr><tr class="xtr-1"><td class="xtd-1-0"><p><strong>460</strong></p></td><td class="xtd-1-1"><p>YDirect регулярный синхрон парсинга реквестов</p></td><td class="xtd-1-2"><p>App\Synchronizers\Stat\YDirect\RegularRequestsParsingSync</p></td><td class="xtd-1-3"><p><br /></p></td></tr><tr class="xtr-2"><td class="xtd-2-0"><p><strong>538</strong></p></td><td class="xtd-2-1"><p>YDirect: Синхрон актуализирует названия для МКБ/Smart кампаний</p></td><td class="xtd-2-2"><p>App\Synchronizers\Stat\YDirect\YDirectCampaignsNamesSolverSync</p></td><td class="xtd-2-3"><p><br /></p></td></tr><tr class="xtr-3"><td class="xtd-3-0"><p><strong>192</strong></p></td><td class="xtd-3-1"><p>YDirect: синхрон групп объявлений</p></td><td class="xtd-3-2"><p>App\Synchronizers\Stat\YDirect\AdGroupSync</p></td><td class="xtd-3-3"><p><br /></p></td></tr><tr class="xtr-4"><td class="xtd-4-0"><p><strong>144</strong></p></td><td class="xtd-4-1"><p>YDirect: синхрон истории измененний(для объявлений)</p></td><td class="xtd-4-2"><p>App\Synchronizers\Stat\YDirect\ChangeSync</p></td><td class="xtd-4-3"><p><br /></p></td></tr><tr class="xtr-5"><td class="xtd-5-0"><p><strong>191</strong></p></td><td class="xtd-5-1"><p>YDirect: синхрон картинок(ссылок) для объявлений</p></td><td class="xtd-5-2"><p>App\Synchronizers\Stat\YDirect\AdImageSync</p></td><td class="xtd-5-3"><p><br /></p></td></tr><tr class="xtr-6"><td class="xtd-6-0"><p><strong>27</strong></p></td><td class="xtd-6-1"><p>YDirect: синхрон по внутренним аккаунтам</p></td><td class="xtd-6-2"><p>App\Synchronizers\Stat\YDirect\LoginSync</p></td><td class="xtd-6-3"><p><br /></p></td></tr><tr class="xtr-7"><td class="xtd-7-0"><p><strong>28</strong></p></td><td class="xtd-7-1"><p>YDirect: синхрон по кампаниям</p></td><td class="xtd-7-2"><p>App\Synchronizers\Stat\YDirect\CampaignSync</p></td><td class="xtd-7-3"><p><br /></p></td></tr><tr class="xtr-8"><td class="xtd-8-0"><p><strong>29</strong></p></td><td class="xtd-8-1"><p>YDirect: синхрон по объявлениям</p></td><td class="xtd-8-2"><p>App\Synchronizers\Stat\YDirect\AdSync</p></td><td class="xtd-8-3"><p><br /></p></td></tr><tr class="xtr-9"><td class="xtd-9-0"><p><strong>504</strong></p></td><td class="xtd-9-1"><p>YDirect: синхрон статистики [ЮСИ]</p></td><td class="xtd-9-2"><p>App\Synchronizers\Stat\YDirect\USI\YDirectInsightsForUsiClientSync</p></td><td class="xtd-9-3"><p>Все интеграции</p><p>Для клиента ЮСИ 2178</p><p>За текущие сутки</p></td></tr><tr class="xtr-10"><td class="xtd-10-0"><p><strong>503</strong></p></td><td class="xtd-10-1"><p>YDirectAds: Создание job-в для синхронизации объявлений</p></td><td class="xtd-10-2"><p>App\Synchronizers\Stat\YDirect\YDirectAdsJobsSync</p></td><td class="xtd-10-3"><p><br /></p></td></tr><tr class="xtr-11"><td class="xtd-11-0"><p><strong>362</strong></p></td><td class="xtd-11-1"><p>YDirectInsights: Создание плана</p></td><td class="xtd-11-2"><p>App\Synchronizers\Stat\YDirect\YDirectInsightsPlanSync</p></td><td class="xtd-11-3"><p>Все логины Яндекса</p><p>С 0 часов текущего дня минус 2 суток</p><p>По 23:59:59 предыдущего дня</p></td></tr><tr class="xtr-12"><td class="xtd-12-0"><p><strong>345</strong></p></td><td class="xtd-12-1"><p>YDirectInsights: Создание плана для получения расходов директа в MySql</p></td><td class="xtd-12-2"><p>App\Synchronizers\Stat\YDirect\YDirectInsightsToMysqlSync</p></td><td class="xtd-12-3"><p>Проход по всем записям невыполненных в части получения данных от Яндекс Директ планов из таблицы YDirect_insights_plan</p></td></tr><tr class="xtr-13"><td class="xtd-13-0"><p><strong>346</strong></p></td><td class="xtd-13-1"><p>YDirectInsights: Создание плана для сохранения расходов директа в ClickHouse</p></td><td class="xtd-13-2"><p>App\Synchronizers\Stat\YDirect\YDirectInsightsToClickhouseSync</p></td><td class="xtd-13-3"><p>Проход по всем записям невыполненных в части передачи данных в Clickhouse планов из таблицы YDirect_insights_plan</p></td></tr><tr class="xtr-14"><td class="xtd-14-0"><p><strong>443</strong></p></td><td class="xtd-14-1"><p>YDirectInsightsKeywords: Создание job-в по ключевым словам директа</p></td><td class="xtd-14-2"><p>App\Synchronizers\Stat\YDirect\YDirectInsightsKeywordsSync</p></td><td class="xtd-14-3"><p>Проход по всем записям невыполненных планов из таблицы YDirect_insights_keywords_plan</p></td></tr><tr class="xtr-15"><td class="xtd-15-0"><p><strong>442</strong></p></td><td class="xtd-15-1"><p>YDirectInsightsKeywords: Создание плана</p></td><td class="xtd-15-2"><p>App\Synchronizers\Stat\YDirect\YDirectInsightsKeywordsPlanSync</p></td><td class="xtd-15-3"><p>Все логины Яндекса</p><p>С 0 часов текущего дня минус 1 сутки</p><p>По 23:59:59 предыдущего дня</p></td></tr></tbody></table><p><br /></p><p>Отдельно стоит рассматривать синхронизацию 65 (Accuracy: основной синхрон заполнения itogs) (класс App\Synchronizers\Stat\Accuracy\DailySync). Как правило, она должна быть запущена после получения данных статистики по расходам и ключевым словам для расчета и проверки достоверности полученных данных.</p><h1>Таблицы</h1><table class="wrapped"><tbody><tr class="xtr-0"><td class="xtd-0-0"><p><strong>Название</strong></p></td><td class="xtd-0-1"><p><strong>Описание</strong></p></td><td class="xtd-0-2"><p><strong>Класс модели</strong></p></td></tr><tr class="xtr-1"><td class="xtd-1-0"><p><strong>smartis_stat.YDirect_insights_plan</strong></p></td><td class="xtd-1-1"><p>План получения данных по расходам из Яндекс Директ</p></td><td class="xtd-1-2"><p>App\Models\Stat\YDirectInsightsPlan</p></td></tr><tr class="xtr-2"><td class="xtd-2-0"><p><strong>smartis_stat.YDirect_insights_new</strong></p></td><td class="xtd-2-1"><p>Данные по расходам из Яндекс Директ</p></td><td class="xtd-2-2"><p>App\Models\Stat\ YDirectInsightsNew</p></td></tr><tr class="xtr-3"><td class="xtd-3-0"><p><strong>smartis_stat.YDirect_Logins</strong></p></td><td class="xtd-3-1"><p>Логины Яндекс Директ</p></td><td class="xtd-3-2"><p>App\Models\Stat\YDirectLogin</p></td></tr><tr class="xtr-4"><td class="xtd-4-0"><p><strong>smartis_stat.accuracy_plan</strong></p></td><td class="xtd-4-1"><p>Запланированные задачи по перерасчету достоверности.</p><p>Сводная таблица по стабильности клиентов</p></td><td class="xtd-4-2"><p>App\Models\Stat\AccuracyPlan</p></td></tr><tr class="xtr-5"><td class="xtd-5-0"><p><strong>smartis_stat.accuracy_itogs</strong></p></td><td class="xtd-5-1"><p>Результаты расчета достоверности</p></td><td class="xtd-5-2"><p>App\Models\Stat\AccuracyItog</p></td></tr><tr class="xtr-6"><td class="xtd-6-0"><p><strong>smartcallback_ch2.insights_ch1</strong></p></td><td class="xtd-6-1"><p>Данные по расходам (общая таблица в Clickhouse)</p></td><td class="xtd-6-2"><p>App\Models\ClickHouse\Stat\Insight (запрещено к использованию)</p><p>App\Models\ClickHouse2\Stat\Insight</p></td></tr></tbody></table><p><br /></p><h1>Схема данных</h1><p>Схема данных реализована с использованием сервиса <a href="https://dbdiagram.io/">https://dbdiagram.io/</a>. В настоящем документе приведен фрагмент схемы. См. также приложение в формате svg.</p><p><br /></p><p><br /></p><h1>Схема классов</h1><p>Интерактивная документация и схема классов реализована как набор веб-страниц с использованием инструмента doxygen. В настоящем документе приведен фрагмент (см. примеры ниже). Полная версия - см. приложение &ndash; архив с интерактивной документацией и схемой классов.</p><p>Ключевые используемые классы:</p><p><br /></p><p><br /></p><table class="wrapped"><tbody><tr class="xtr-0"><td class="xtd-0-0"><p><strong>Класс</strong></p></td><td class="xtd-0-1"><p><strong>Описание</strong></p></td><td class="xtd-0-2"><p><strong>Примечание</strong></p></td></tr><tr class="xtr-1"><td class="xtd-1-0"><p><strong>App\Synchronizers\Stat\YDirect\YDirectInsightsPlanSync</strong></p></td><td class="xtd-1-1"><p>Яндекс.Директ - Синхрон 362 - YDirectInsights: Создание плана.</p></td><td class="xtd-1-2"><p><br /></p></td></tr><tr class="xtr-2"><td class="xtd-2-0"><p><strong>App\Synchronizers\Stat\YDirect\YDirectInsightsToMysqlSync</strong></p></td><td class="xtd-2-1"><p>Яндекс.Директ - Синхрон 345 - YDirectInsights: Создание плана для получения расходов директа в MySql</p></td><td class="xtd-2-2"><p><br /></p></td></tr><tr class="xtr-3"><td class="xtd-3-0"><p><strong>App\Synchronizers\Stat\YDirect\YDirectInsightsToClickhouseSync</strong></p></td><td class="xtd-3-1"><p>Яндекс.Директ - 346 - YDirectInsights: Создание плана для сохранения расходов директа в ClickHouse</p></td><td class="xtd-3-2"><p><br /></p></td></tr><tr class="xtr-4"><td class="xtd-4-0"><p><strong>App\Synchronizers\Stat\Accuracy\DailySync</strong></p></td><td class="xtd-4-1"><p>Синхрон 65 - &nbsp;основной синхрон заполнения accuracy_itogs</p></td><td class="xtd-4-2"><p><br /></p></td></tr><tr class="xtr-5"><td class="xtd-5-0"><p><strong>App\Services\YDirect\YDirectInsightsPlanService</strong></p></td><td class="xtd-5-1"><p>Сервис методов выполнения синхронизаций расходов Яндекс Директ</p></td><td class="xtd-5-2"><p><br /></p></td></tr><tr class="xtr-6"><td class="xtd-6-0"><p><strong>App\Classes\YDirect\Dto\YDirectInsightsPlanDto</strong></p></td><td class="xtd-6-1"><p>DTO для YandexDirectInsightsPlan (таблица YDirect_insights_plan)</p></td><td class="xtd-6-2"><p><br /></p></td></tr><tr class="xtr-7"><td class="xtd-7-0"><p><strong>App\Managers\YDirect\YDirectInsightsPlansManager</strong></p></td><td class="xtd-7-1"><p>Менеджер для YDirectInsightsPlan (таблица YDirect_insights_plan)</p></td><td class="xtd-7-2"><p><br /></p></td></tr><tr class="xtr-8"><td class="xtd-8-0"><p><strong>App\Repositories\YDirectInsightsPlansRepository</strong></p></td><td class="xtd-8-1"><p>Репозиторий для модели YDirectInsightsPlan (таблица YDirect_insights_plan)</p></td><td class="xtd-8-2"><p><br /></p></td></tr><tr class="xtr-9"><td class="xtd-9-0"><p><strong>App\Repositories\YDirectInsightsNewRepository</strong></p></td><td class="xtd-9-1"><p>Репозиторий для модели YDirectInsightsNew (таблица YDirect_insights_new)</p></td><td class="xtd-9-2"><p><br /></p></td></tr><tr class="xtr-10"><td class="xtd-10-0"><p><strong>App\Jobs\YDirect\YDirectInsightsToMySqlJob</strong></p></td><td class="xtd-10-1"><p>Задание получения расходов из Яндекс Директ и помещения их в промежуточную таблицу smartis_stat.YDirect_insights_new</p></td><td class="xtd-10-2"><p><br /></p></td></tr><tr class="xtr-11"><td class="xtd-11-0"><p><strong>App\Jobs\YDirect\YDirectInsightsToClickHouseJob</strong></p></td><td class="xtd-11-1"><p>Задание обогащения и переноса расходов из промежуточной таблицы smartis_stat.YDirect_insights_new в таблицу Clickhouse smartcallback_ch2.insights_ch1</p></td><td class="xtd-11-2"><p><br /></p></td></tr></tbody></table><p><br /></p><h2>Иерархия классов (пример)</h2><p><br /></p><h2>&nbsp;</h2><h2>Collaboration diagram for YDirectInsightsPlanSync:</h2><p><br /></p><h2>Member Function Documentation</h2><p><br /></p><h2>Data Structure Index</h2><p><br /></p><h2>Data Fields</h2><p><br /></p><p><br /></p><p><br /></p><h1>Приложения</h1><p>Приложение 1. Схема данных в формате svg.</p><p><ac:structured-macro ac:name="view-file" ac:schema-version="1" ac:macro-id="ac163763-7920-4a09-845f-823006a38432"><ac:parameter ac:name="name"><ri:attachment ri:filename="Smartis.svg" /></ac:parameter><ac:parameter ac:name="height">250</ac:parameter></ac:structured-macro></p><p>Приложение 2. Интерактивная документация и схема классов в архиве zip.</p><p><ac:image ac:thumbnail="true" ac:height="250"><ri:attachment ri:filename="Smartis.png" /></ac:image><ac:structured-macro ac:name="view-file" ac:schema-version="1" ac:macro-id="2831b9ea-08c3-47d7-9418-82ed63939001"><ac:parameter ac:name="name"><ri:attachment ri:filename="Smartis_doxygen_html.zip" /></ac:parameter><ac:parameter ac:name="height">250</ac:parameter></ac:structured-macro></p><h1>Список литературы</h1><p><em>1. Яндекс Директ</em>. б.д. &lt;<a href="https://docs.uiscom.ru/pages/viewpage.action?pageId=171324534">https://docs.uiscom.ru/pages/viewpage.action?pageId=171324534</a>&gt;.</p><p><em>9.2 [Для разработчика] Модуль достоверности</em>. б.д. &lt;<a href="https://docs.uiscom.ru/pages/viewpage.action?pageId=169524426">https://docs.uiscom.ru/pages/viewpage.action?pageId=169524426</a>&gt;.</p><p><em>Обзор API Директа версии 5</em>. б.д. &lt;<a href="https://yandex.ru/dev/direct/doc/dg/concepts/overview.html">https://yandex.ru/dev/direct/doc/dg/concepts/overview.html</a>&gt;.</p><p><em>Яндекс Директ</em>. б.д. &lt;<a href="https://direct.yandex.ru/">https://direct.yandex.ru/</a>&gt;.</p><p><br /></p>