<ac:layout><ac:layout-section ac:type="two_right_sidebar"><ac:layout-cell><h3>Кеш необходим для:</h3><ol><li>Быстрого ответа тех данных, которые недавно &quot;брались&quot;<ol><li>Извлечь данные из базы данных или из файлов иногда бывает очень долго - несколько минут и до часу</li><li>Из кеша такие данные можно будет достать за секунды даже при условии что они брались из БД час</li></ol></li><li>Для экономии серверных ресурсов&nbsp;<ol><li>Каждый раз искать по базе данных сложные запросы бессмысленно нагружает сервер</li></ol></li></ol><p><br /></p><p>Кеш обычно запоминается на &quot;время кеширования&quot;.&nbsp;</p><p><br /></p><h3>В Smartis есть разного рода кеш, на разное время:</h3><ol><li><strong>sql-кеш отчета</strong>&nbsp;- 10 минут<ol><li>Зачем: чтобы при тех же параметрах отчета - отдать построенный в течение 10 минут отчет за 1-2 секунды</li><li>Где хранится:&nbsp;array-redis</li><li>Ключ: md5(sql-запроса)<br />Любое изменение параметров отчета - меняет&nbsp;sql-запрос, а значит это либо уже другой кеш или данные возьмутся не из кеша</li><li>Время кеширования задается тут: \App\Storages\ResponseMetricDataCacheHelperStorage::saveReportDataBySqlHash</li></ol></li><li><strong>Кеш контроллера отчетов</strong>&nbsp;- 30 минут (было 60 минут когда все жаловались на кеш, тестируем уменьшение)<ol><li>Зачем: когда строится отчет с несколькими показателями - мы отправляем их строиться параллельно, затем когда каждый отдельный готов - собираем их из кеша в единый отчет.</li><li>Где хранится:&nbsp;redis-database</li><li>Логика ключей и преобразований для кеша тут \App\Storages\ReportBaseStorage::getReportMetricData</li></ol></li><li><strong>Кеш анализа по моделям атрибуции - 1 день</strong><ol><li>Зачем:<ol><li>Запомнить как раскладывается конверсия (срм или обращение) по источникам в конкретной модели атрибуции, в конкретном окне ретро, с/без учета прямого трафика.</li><li>Чтобы: ускорить отчеты срм или обращений по моделям, где нужно группировать или фильтровать по источникам</li><li>Чтобы: Ускорить повторное открытие детализации срм (колонки Канал/площадка и источники json - берутся по итогам анализа по моделям</li></ol></li><li>Где хранится: mysql БД&nbsp;temporary_tables</li><li>Ключ:&nbsp;~имя таблицы, пример:&nbsp;ma_<strong>crm</strong>_<strong>230725</strong>_<strong>1156</strong>_<strong>1</strong>_4863dac7 =&gt; ma_ТИПДАННЫХ_ДАТАКЕШИРОВАНИЯ_КЛИЕНТ_МОДЕЛЬ</li><li>Время кеширование определяется логикой наименования таблицы - всегда берется&nbsp;ДАТАКЕШИРОВАНИЯ = сегодня<br /><br /><br /></li></ol></li></ol><p>Для пользователей XRM и наших разработчиков - в интерфейсе конструктора отчетов доступен&nbsp;<strong>переключатель &quot;Кеширование&quot;</strong>. Работает и в облаке, и в коробке.</p><p>Когда он нужен:</p><ul><li>Обновили данные через интерфейс мониторинга данных и надо проверить как выглядит отчет</li><li>Разработчик по вашей просьбе пнул какой либо синхрон чтобы поправить данные</li><li>Импортировали расходы или другие данные через Импорт - надо проверить данные</li><li>Вы перенастроили привязки или формулу показателя или другие параметры продукта и надо проверить как изменился отчет</li><li>Вы следите за тем как меняются данные в автоматическом режиме чаще чем раз в 30 мин (например обращения-вебхуки)</li></ul><p>Чтобы в процессе работы с данными или настройки нашего продукта - не ждать &quot;время кеширования&quot; разного рода и не дергать разработчиков просьбами &quot;сбросьте кеш&quot;.&nbsp;</p><p>С состоянием &quot;Вкл&quot; (зеленый) - кеширование будет работать, и если отчет с такими параметрами есть в кеше - вы увидите быстрый отчет из кеша.</p><p>С состоянием &quot;Выкл&quot; (серый) - кеширование всех трех видов которые описаны выше - выключается, отчет будет собираться с нуля из сырых данных</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><ac:image ac:height="400"><ri:attachment ri:filename="image2023-8-21_9-36-41.png" /></ac:image></span></p><p><br /></p><p>Обычным &quot;смертным&quot; (клиентам), этот переключатель не показываем специально - чтобы для них отчеты строились быстро, не нагружая наши сервера.&nbsp;</p><p>При обращениях клиентов &quot;кеш мешает&quot; - оформляйте тикет, будем придумывать как улучшить его, чтобы не мешал, но совсем убирать кеш у клиентов - нельзя</p></ac:layout-cell><ac:layout-cell><p><ac:structured-macro ac:name="toc" ac:schema-version="1" ac:macro-id="37f77ad3-c179-453f-9833-9a1a62b71d88" /></p></ac:layout-cell></ac:layout-section></ac:layout>