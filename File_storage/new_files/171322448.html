<ac:layout><ac:layout-section ac:type="two_right_sidebar"><ac:layout-cell><h3>Основная информация&nbsp;</h3><p>Сервис &ldquo;CRM Endpoint&rdquo; предназначен для получения данных из различных CRM систем -&nbsp;<span style="color: rgb(30,31,33);">чтобы выкачивать CRM данные из различных источников. Пример использования: клиент Неометрия.</span></p><p><strong>Подходит во всех кастомных интеграциях, где клиент предоставляет нам доступ в срм, веб-сервис и т.д. </strong>В данный момент все кастомные интеграции делаем через него.</p><p>Для настройки нужно указать, инфо по каким полям нужно получить от клиента:</p><ol class="RichTextList-numbered"><ol class="RichTextList-numbered"><li><p>В идеале, в получить описание в модели данных. Есть идея упростить это через опросник для клиента: <a class="PrimaryNavigationLink BaseLink" href="https://app.asana.com/0/1200433709693950/1205860465212971">Интерфейс проработки модели данных CRM</a>. <span style="color: rgb(255,0,0);">пока на стадии идеи</span></p></li><li><p>в Smartis должна появиться возможность смотреть и редактировать доп. поля, см. <a href="https://app.asana.com/0/1204595668271208/1205977996157451" class="PrimaryNavigationLink BaseLink">Все клиенты, Админка: управление доп. полями</a>&nbsp;</p></li><li><p>В сервисе CrmEndpoint мы указываем соответствие между полями, которые приходят из внешней CRM и нашими полями.</p><p>И когда мы получаем данные, мы будем приводить значения полей из внешней CRM к нашему типу поля&nbsp;<span style="color: rgb(0,0,0);">автоматически (например, если у клиента дата указана отличном от нашего формате, мы сможем это распознать и обработать, привести к нашему типу)</span></p></li><li><p>на внедрении CRM через данный сервис с клиентом требуется обсудить регистр названий полей (лучше: использовать единый (нижний, например). Но ни в коем случае не переделывать старый, когда уже передача данных через CRM Endpoint настроена.</p><p><span style="color: rgb(0,0,0);"><br /></span></p></li></ol></ol><h3>Мониторинг в графана:&nbsp;<a href="https://grafana.smartis.bi/d/XR61m2EIk/crm-endpoint?orgId=1">https://grafana.smartis.bi/d/XR61m2EIk/crm-endpoint?orgId=1</a><br /><br /><span style="color: rgb(0,0,0);">Настройка интеграции</span></h3><ol><li>Перед началом работы необходимо создать CRM аккаунт. Каждое подключение этого сервиса даёт возможность создать одну сущность и контактом.</li><li>включить коннектор CRM</li></ol><p><ac:image ac:height="250"><ri:attachment ri:filename="image2023-11-20_20-4-48.png" /></ac:image></p><p>&nbsp; &nbsp; &nbsp; &nbsp;3. Затем можно приступать к настройке каждой сущности.&nbsp;<span style="letter-spacing: 0.0px;">Все обязательные поля помечены звёздочкой</span></p><p><ac:image ac:width="600"><ri:attachment ri:filename="image2023-11-20_20-5-10.png" /></ac:image></p><p><ac:image ac:width="500"><ri:attachment ri:filename="Снимок экрана 2024-01-22 в 15.48.22.png" /></ac:image></p><p>Настройки делятся по блокам:</p><ul><li>В настройках подключения указываем способ взаимодействия с внешним API</li><li>Если не заполнить основные поля, то интеграция работать не будет</li><li>Поля контакта будут использованы при создании контакта</li><li>В поле &ldquo;Соответствие полей&rdquo; необходимо указать в какие доп. поля Smartis необходимо сохранять значения по указанным ключам. Важно: в выпадающем списке отображаются только те поля, которые доступны в выбранной сущности CRM endpoint</li><li><strong>*отображение в достоверности</strong> - включить, если нужно отображать достоверность в Мониторинге системы по этой интеграции (включаем только в интеграции, которая создана для достоверности. О том, как это сделать - читать ниже)</li><li>Интервал забора данных - как часто нужно обновлять данные по интеграции? (минимальное значение 1 час или 3600 секунд. <strong>Если указать меньше,&nbsp;</strong><span style="color: rgb(30,31,33);"><strong>интеграция отключится, когда дойдёт очередь до синхронизации</strong>)</span></li><li><span style="color: rgb(30,31,33);">Глубина забора данных - период ретро, за который обновляем данные с заданным выше интервалом.</span></li></ul><p>Если значения полей (как основных, так и дополнительных) являются вложенными, то путь до этого поля можно указать через точку, например, чтобы получить значение из</p><pre><code class="language-jsx">{
    &quot;foo&quot;: {
        &quot;bar&quot;: &quot;baz&quot;
    }
}
</code></pre><p>поле можно указать как <code>foo.bar</code></p><p>В Smartis есть полезная команда для быстрого формирования списка соответствия дополнительных полей: <code>artisan crm:cf:first-or-create</code></p><p>В настройках guzzle можно использовать следующий placeholder-ы:</p><ul><li><code>%from%</code> - дата &ldquo;с&rdquo; в формате <code>Y-m-d H:i:s</code>, например: <code>2023-11-20 19:51:20</code></li><li><code>%to%</code> - дата &ldquo;по&rdquo; в формате <code>Y-m-d H:i:s</code>, например: <code>2023-11-20 19:51:20</code></li><li><code>%offset%</code> - количество полученных до этого запроса элементов, например <code>100</code></li></ul><p>При первом запуске в <code>%from%</code> и <code>%to%</code> будет указано с 1 января 2015-го года по настоящий момент, далее раз в час будем забирать данные с момента последнего запуска по настоящее время.</p><p><br /></p><h3>Достоверность по CRM Endpoint</h3><p>Для данного сервиса доступен подсчет достоверности - она отображается в разделе Мониторинг системы.&nbsp;</p><p><strong>Достоверность показывает:</strong> <br />у нас: сколько строк у нас<br />в БД: сколько строк возвращает API</p><p>Также достоверность по CRM Endpoint подсвечивает уведомление, в случае когда более 3% сущностей из CRM по отдельной интеграции не имеют контактов.&nbsp;Для тех сущностей, где есть (должны быть) идентификационные данные персоны (телефон)<br /><br /><ac:image ac:width="400"><ri:attachment ri:filename="image (1).png" /></ac:image></p><p>актуально для сущности по которой мы показываем эту ошибку (тк в данной модели 1 сущность = 1 интеграция с CRM Endpoint). При этом на самой достоверности низкий % связки не отображается</p><p>Если у клиента в CRM удаляются какие-то данные, а в смартис они попросили нас эти данные не удалять, то в достоверности будут дни с низким процентом. Это связано с тем, что в смартис по факту будет больше данных, чем в срм (из-за удаления в срм). Эта ситуация считается нормальной. Поэтому, чтобы достоверность была информативной и подсвечивала только ситуации с нехваткой данных, с помощью шаблонной задачи в разработку можно выполнить настройку, которая в случае когда у нас данных больше чем в срм будет все равно считать достоверность 100%.<br />Шаблонная задача по ссылке:&nbsp;</p><p><a href="https://app.asana.com/0/1206876306252490/1208056191752178/f"><span style="color: rgb(0,151,167);">https://app.asana.com/0/1206876306252490/1208056191752178/f</span></a></p><p><ac:image ac:thumbnail="true" ac:height="250"><ri:attachment ri:filename="Снимок экрана 2024-08-16 в 11.02.53.png" /></ac:image></p><p>в примере на скрине у нас 9 сущностей, а в срм - 7. при этом достоверность 100%, тк это превышение нормально.</p><h3>Как настроить отображение достоверности по CRM Endpoint для клиента:</h3><p><strong>Важно:</strong> проверить что прописано в интеграции с&nbsp;CRM Endpoint в строке &quot;параметры Guzzle&quot;: если там выражение в котором нет параметра ModifiedOn - то для отображения достоверности по ней нужно просто включить &quot;отображение в достоверности&quot; в настройках интеграции.<br /><ac:image ac:height="250"><ri:attachment ri:filename="Снимок экрана 2024-02-01 в 15.40.51.png" /></ac:image></p><p>Если в строке &quot;параметры Guzzle&quot; есть параметр&nbsp;ModifiedOn - то двигаемся по этой инструкции:</p><ol><li>Достоверность отдельно нужно настраивать для каждой созданной интеграции с данным сервисом (если у вас 5 интеграций в клиенте, то для каждой из них настраивается отдельно).</li><li>В разделе интеграций необходимо подключить новую интеграцию с&nbsp;CRM Endpoint и скопировать в нее все настройки из уже существующей интеграции с&nbsp;CRM Endpoint. Для удобства новую интеграцию называем &quot;Достоверность _____&quot;<br /><em>Пример: у вас есть 3 интеграции с&nbsp;CRM Endpoint по сущностям: сделки, визиты, контакты. Если вам нужно видеть достоверность в мониторинге системы по всем этим интеграциям, вам нужно создать 3 новые интеграции по этим же сущностям и назвать их &quot;Достоверность Сделки&quot; и т.д. В каждую созданную интеграцию для достоверности копируете полностью настройки, чтобы были такие же как в ранее созданной. В результате у вас добавится 3 новые интеграции с названием &quot;Достоверность ___&quot; и идентичными настройками.</em></li><li>Далее в настройки интеграции &quot;Достоверность___&quot; нужно внести изменения:&nbsp;<ol><li>включить &quot;отображение в достоверности&quot;</li><li>в строке &quot;параметры Guzzle&quot; <strong>только после параметра WHERE</strong> заменить слово ModifiedOn на CreatedOn.&nbsp;</li></ol></li></ol><p><strong>Было:</strong><br /><ac:image ac:width="500"><ri:attachment ri:filename="Снимок экрана 2024-01-25 в 15.33.51.png" /></ac:image><br /><strong>Стало:<br /><ac:image ac:width="500"><ri:attachment ri:filename="Снимок экрана 2024-01-25 в 15.33.19.png" /></ac:image></strong><br />Далее нажимаем &quot;сохранить&quot;. После этого синхрон расчета достоверности при следующем запуске обработает данные по интеграции и они отобразятся в мониторинге системы. Если включили сегодня - данные появятся завтра утром (тк 65 синхрон работает рано утром).<br /><br /><br /><strong>Важно:</strong> <br />-&nbsp;в интеграции НЕ для достоверности не нужно включать &quot;отображение в достоверности&quot; - тк в таком случае данные будут считаться по дате изменения и достоверность будет низкой и неверной.<br />- в&nbsp;интеграции НЕ для достоверности не нужно менять&nbsp;слово ModifiedOn на CreatedOn в строке&nbsp;&quot;параметры Guzzle&quot;. В таком случае интеграция <strong>отвалится</strong><br />- в списке интеграций в мониторинге системы отобразятся только те, которые вы создали &quot;копированием&quot; и включили у них &quot;отображение в достоверности&quot;</p><ul style="list-style-type: square;"><li><span style="letter-spacing: 0.0px;">красным должны гореть только те интеграции достоверности, по которым есть ошибка (именно в разделе интеграций).&nbsp;</span>если ошибки нет и интеграция работает - она не должна быть красным</li></ul><p><br /></p><p><br /><br /><br />Для отображения в достоверности ретро данных этой интеграции необходимо вручную обновить достоверность. Это делается стандартно - в разделе Мониторинг системы нужно выбрать интересующий период и нажать обновить &quot;Достоверность&quot;.</p><h3>Особенности настройки достоверности для интерации, использующей драйвер Подключение к БД</h3><p>Например, такие интеграции автоматически создаются для каждой сущности MacroData при создании основной интеграции MacroData&nbsp;(см. <ac:link><ri:page ri:content-title="5. MacroData" /></ac:link>)</p><p>Как и было упомянуто выше, интеграция CRMEndpoint для определения достоверности, должна полностью повторять настройки интеграции CRMEndpoint&nbsp;для получения данных (основной интеграции), за исключением следующих моментов:</p><ol><li>В запросе получения данных (поле Запрос) в настройках основной интеграции в условии WHERE для ограничения дат должно использоваться поле, содержащее дату обновления записи. Например, оно может называться updated, updated_at, date_updated и т.п. А в поле запрос в настройках интеграции для определения достоверности должно быть указано поле, содержащее дату создания записи.&nbsp;Например, оно может называться&nbsp;created,&nbsp;created_at, date_created&nbsp;и т.п.</li><li>В настройках интеграции CRMEndpoint для определения достоверности должен быть включен параметр&nbsp;<label class="el-form-item__label" for="count_accuracy"><span>Отображается в достоверности.</span></label></li><li><label class="el-form-item__label" for="count_accuracy"><span>Настройки&nbsp;интеграции CRMEndpoint для определения достоверности&nbsp;<label class="el-form-item__label" for="run_interval"><span>Интервал забора данных и&nbsp;<label class="el-form-item__label" for="depth_interval"><span>Глубина забора данных как правило содержат одинаковые значения&nbsp;86400.</span></label></span></label></span></label></li></ol><p>&nbsp;</p><h3>Добавление новых полей&nbsp;</h3><p>Для добавления новых полей непобходимо:</p><ol><li>Добавить их в модель данных, должно быть техническое название и название поля на русском;</li><li>Поставить шаблонную задачу на консультацию;</li><li>Добавить в интеграцию эти поля, прописать их. У каждой сущности своя интеграция;</li><li>Просинхронить за тестовый период;</li><li>Протестировать появились ли поля;</li><li>Просинхронить за нужный пениод;</li><li>Протестировать появились ли поля</li></ol><p><br /></p><h3><strong>Работа с часовыми поясами</strong></h3><p><strong>smartis_stat.services</strong><br /><strong>id</strong> = 91<br /><strong>title</strong> = 'CRM Endpoint'<br /><strong>service_class</strong> = '\App\Classes\CrmEndpoint\Core'</p><p>Существует <strong>2</strong> способа получения данных по сервису <strong>CRM Endpoint</strong>:<br /><strong>Подключение к БД</strong> (<em>прямой запрос к </em><em><strong>БД</strong></em>)<br /><strong>HTTP Guzzle Client</strong> (<em>запросы к </em><em><strong>API</strong></em>)</p><p>-----<br /><strong>Подключение к БД </strong>(<em>CRM Endpoint</em>)</p><p><strong>1.) можем ли мы автоматически брать из сервиса настройку часового пояса? как работает эта настройка?</strong></p><p>На данный момент мы <strong>не получаем текущий часовой пояс клиента</strong> при типе соединения <strong>Подключение к БД</strong> из интеграции сервиса <strong>CRM Endpoint</strong> по какой либо сущности.<br />Есть вариант <strong>модификации запроса</strong> по сущности к <strong>БД</strong> клиента чтобы привести получаемые <strong>поля сущности к часовому поясу который нам нужен</strong>, это некоторое подобие настройки часового пояса на нашей на нашей стороне.<br />Пример строк модификации получаемых полей сущности для приведения к <strong>Московскому часовому поясу</strong> (<em><strong>+3</strong></em><em> часа, клиент </em><em><strong>ПИК</strong></em>):<br /><code>SELECT</code><br /><code>dateadd(HOUR, 3, l.CreatedOn) AS CreatedOn, # <strong>Дата создания +3 часа</strong></code><br /><code>dateadd(HOUR, 3, l.ModifiedOn) AS ModifiedOn, # <strong>Дата изменения +3 часа</strong></code><br /><code>FROM Leads AS l</code><br /><code>WHERE ...</code><br /><code>;</code></p><p>Для расчета достоверности в интеграции <strong>CRM Endpoint </strong>существует настройка <strong>Часовой пояс</strong>, где <strong>указывается часовой пояс в котором содержаться данные клиента</strong> о сущности по которой мы получаем данные. При запросе к <strong>БД</strong> данный часовой пояс подставляется в параметр даты запроса и мы можем обновить достоверность по сущности именно на дату в часовом поясе клиента.</p><p>Связанные методы:<br /><code>\App\Classes\CrmEndpoint\Services\TableDataService::run</code><br /><code>\App\Classes\CrmEndpoint\Services\DataRetrievers\DatabaseDataRetriever::retrieveData</code><br /><code>\App\Classes\CrmEndpoint\Accuracy::getIntegrationTimeZone</code></p><p><strong>2.) можем ли мы вообще на своей стороне вносить правки, чтобы данные по сервису отображались в нужном нам часовом поясе?</strong></p><p>Есть <strong>вариант модификации запроса</strong> по сущности к <strong>БД</strong> клиента чтобы привести получаемые поля сущности к часовому поясу который нам нужен, это некоторое подобие настройки часового пояса на нашей на нашей стороне.</p><p><strong>3.) знаем ли мы, в каком часовом поясе приходят данные из сервиса?</strong></p><p>Не знаем, берем даты сущностей как есть, как они приходят к нам из <strong>БД</strong> клиента. Часовой пояс указывается вручную в настройке <strong>Часовой пояс</strong> в интеграции.</p><p>-----<br /><strong>HTTP Guzzle Client</strong> (<em>CRM Endpoint</em>)</p><p><strong>1.) можем ли мы автоматически брать из сервиса настройку часового пояса? как работает эта настройка?</strong></p><p>На данный момент мы <strong>не получаем текущий часовой пояс</strong> при типе соединения <strong>HTTP Guzzle Client</strong> из интеграции сервиса <strong>CRM Endpoint</strong> по какой либо сущности.<br />Для получения данных или расчета достоверности при типе соединения <strong>HTTP Guzzle Client</strong> в интеграции <strong>CRM Endpoint</strong> существует настройка <strong>Часовой пояс</strong>, где указывается часовой пояс в котором содержаться данные клиента о сущности по которой мы получаем данные. При запросе к <strong>API</strong> данный часовой пояс подставляется в параметр даты запроса и мы можем получить данные или обновить достоверность по сущности именно на дату в часовом поясе клиента.</p><p>Связанные методы:<br /><code>\App\Classes\CrmEndpoint\Services\DataRetrievers\GuzzleDataRetriever::retrieveData</code><br /><code>\App\Classes\CrmEndpoint\Accuracy::getIntegrationTimeZone</code></p><p><strong>2.) можем ли мы вообще на своей стороне вносить правки, чтобы данные по сервису отображались в нужном нам часовом поясе?</strong></p><p>Можем, но не будем. По всем сервисам. В интерфейсе мы отображаем все данные в едином часовом поясе.</p><p><strong>3.) знаем ли мы, в каком часовом поясе приходят данные из сервиса?</strong></p><p>Не знаем, берем даты сущностей как есть, как они приходят к нам из <strong>API</strong>. Часовой пояс указывается вручную в настройке <strong>Часовой пояс</strong> в интеграции.</p></ac:layout-cell><ac:layout-cell><p><ac:structured-macro ac:name="toc" ac:schema-version="1" ac:macro-id="6b0b50a7-dc72-434a-abbb-8f26f3b37b9b" /></p></ac:layout-cell></ac:layout-section></ac:layout>