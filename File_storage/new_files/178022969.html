<p><strong>Прокси для запросов в Отрада</strong></p><p>Адрес сервера:</p><p>10.1.73.115</p><p>Адрес приложения:</p><p>/var/dockerfiles/mssqlapi/var/www</p><p><br /></p><p>Если нет CRM данных и есть ошибки:</p><p>[Microsoft][ODBC Driver 17 for SQL Server]Login timeout expired</p><p>[Microsoft][ODBC Driver 17 for SQL Server]TCP Provider: Error code 0x2749</p><p>[Microsoft][ODBC Driver 17 for SQL Server]A network-related or instance-specific error has occurred while establishing a connection to SQL Server. Server is not found or not accessible. Check if instance name is correct and if SQL Server is configured to allow remote connections. For more information see SQL Server Books Online.</p><p>То смотрим адрес сервера и приложения.</p><p><br /></p><h5 class="TypographyPresentation TypographyPresentation--colorDefault TypographyPresentation--h5 TypographyPresentation--fontWeightMedium RichText3-header2--withVSpacingNormal RichText3-header2"><span>Описание синхрона сервиса </span><em><span>Microsoft Dynamics CRM</span></em><span> для клиента 1156 и кастомной </span><em><span>API</span></em><span> системы\proxy</span></h5><p><br />Для синхронизации с сервисом <span>Microsoft Dynamics CRM</span> клиента <span>1156</span> используется синхрон <span>161</span> (<em>MDynamicsCRM MSSQL: синхрон всех сущностей</em>) <code>App\Synchronizers\Stat\MDynamicsCRM\Mssql\AllSync</code> который работает <span>только для данного клиента</span>.</p><p>Выбор клиента <span>1156</span> и его интеграций для синхронизации на данный момент <span>зафиксирован прямо в коде</span> приложения\синхрона (<code>\App\Synchronizers\Stat\MDynamicsCRM\Mssql\AllSync::run</code>).</p><p>На данный момент выбирается только одна интеграция <span>mig.corp.local\Smartis</span> сервиса <span>Microsoft Dynamics CRM</span> для синхронизации:<br /><span>smartis_stat.integrations</span><br /> <span>id</span> = 5163<br /> <span>client_id</span> = 1156<br /> <span>title</span> = 'mig.corp.local\Smartis'<br /> <span>service_id</span> = 33 (<em>Microsoft Dynamics CRM</em>)<br /> <br />Синхрон <span>161</span> (<em>MDynamicsCRM MSSQL: синхрон всех сущностей</em>) запускается <span>каждый час</span> за период от <span>4 часа в ретро</span> до <span>конца текущего часа</span>.<br />Данное время запуска синхрона (<em><span>4</span></em><em> часа в ретро</em>) указано прямо в коде в <code>-&gt;setPeriod()</code>. Что бы запустить синхрон за другую дату нужно указать время в формате <span>2024-09-30 00:00:00</span> в <code>-&gt;setPeriod()</code> непосредственно в коде в <code>\App\Synchronizers\Stat\MDynamicsCRM\Mssql\AllSync::run</code>.</p><p>При работе синхрона происходят запросы к нашему адресу <span><a href="http://dev.smartcallback.ru:8033/">http://dev.smartcallback.ru:8033/</a></span> который указан в <code>config('app.mssql_proxy_host')</code>.<br />В свою очередь наша оснастка которая <span>доступна по данному адресу</span> отправляет запросы к <span>БД</span> клиента в виде <span>SQL запросов</span> и далее выводит ответ или текст ошибки в <span>JSON</span> виде.</p><p>Для клиента существует еще <span>два</span> синхрона для сервиса <span>Microsoft Dynamics CRM</span> где в коде для запуска явно указан только данный клиент (<span>1156</span>):<br /><span>170</span> (<em>MDynamicsCRM MSSQL: контроль удаленных данных</em>) <code>App\Synchronizers\Stat\MDynamicsCRM\Mssql\EntityDataControlDeletedSync</code><br /><span>185</span> (<em>MDynamicsCRM MSSQL: суточный синхрон всех сущностей</em>) <code>App\Synchronizers\Stat\MDynamicsCRM\Mssql\DailyAllSync</code></p><p>Синхрон <span>170</span> (<em>MDynamicsCRM MSSQL: контроль удаленных данных</em>) запускается <span>один раз в сутки</span> за <span>6 месяцев</span> в ретро и по <span>конец текущего дня</span>.</p><p>Синхрон <span>185</span> (<em>MDynamicsCRM MSSQL: суточный синхрон всех сущностей</em>) запускается <span>один раз в сутки</span> в <span>4 часа</span> за <span>7 дней</span> в ретро и по <span>конец текущего дня</span>.</p><p>Для этих <span>двух</span> синхронов используется та же логика с <span>API\proxy</span> по адресу <span><a href="http://dev.smartcallback.ru:8033/">http://dev.smartcallback.ru:8033/</a></span> как и в синхроне <span>161</span> (<em>MDynamicsCRM MSSQL: синхрон всех сущностей</em>).</p><h5 class="TypographyPresentation TypographyPresentation--colorDefault TypographyPresentation--h5 TypographyPresentation--fontWeightMedium RichText3-header2--withVSpacingNormal RichText3-header2"><span>Синхрон создания маркетинговых касания для клиента когда еще не было продуктовой возможности это делать через интеграцию</span></h5><p>Для клиента существует кастомный синхрон <span>193</span> (<em>Отрада: создание маркетинговых касаний по звонкам</em>) <code>App\Synchronizers\Stat\SpecialClientsSyncs\Otrada\ProcessUnreachedCrmCalls</code></p><p>Данный синхрон <span>запускается каждый день</span> в <span>7 часов</span> утра.<br />В данном синхроне идет получение <span>звонков Microsoft Dynamics</span> клиента с <span>начала предыдущего дня</span> до <span>текущего момента</span> и на их основе создаются маркетинговые касания как <span>обращения</span> сервиса <span>Битрикс24 - импорт вручную</span> (<em>ID 41</em>).</p><p>Возможно данный синхрон не актуален так как последнее обращение по нему было создано <span>2021-08-24 13:43:37</span>:<br />Фильтр для проверки:<br /><code><span>smartis_stat.requests</span>.<span>client_id</span> = 1156 AND <span>service_id</span> = 41 ORDER BY <span>date</span> DESC</code>.</p><h5 class="TypographyPresentation TypographyPresentation--colorDefault TypographyPresentation--h5 TypographyPresentation--fontWeightMedium RichText3-header2--withVSpacingNormal RichText3-header2"><span>Логика в коде по клиенту </span><em><span>Отрада</span></em><span> (</span><em><span>ID 1156</span></em><span>) для исключения его из обычной логики получения данных по сервису </span><em><span>Microsoft Dynamics CRM</span></em></h5><p>В синхроне <span>159</span> (<em>MS Dyn: контроль удаленных данных</em>) в методе <code>\App\Synchronizers\Stat\MDynamicsCRM\V1\EntityDataControlDeletedSync::run</code> есть отмена выбора интеграций клиента <span>1156</span> для запусков данного синхрона.</p><p>Получение всех интеграций сервиса <span>Microsoft Dynamics CRM</span> за исключением клиента <span>Отрада</span> (<em>1156</em>) в методе <code>\App\Repositories\IntegrationsRepository::getDynamicsIntegrations</code>.</p><p>Получение данных для <span>расчета достоверности</span> за исключением клиента <span>Отрада</span> (<em>1156</em>) в методе <code>\App\Classes\Accuracy\Services\AccuracyData::getForRun</code>.</p><p>Получение данных для показа итогов достоверности в таблице за исключением клиента <span>Отрада</span> (<em>1156</em>) в методе <code>\App\Classes\SystemMonitoring\Table\AccuracyItogsTableCreator::getIntegrationsForShow</code>.</p><p>Перезабор данных из личного <span>кабинета\конструктора</span> отчетов по <span>кнопке\ссылке</span> с <span>особой логикой</span> для клиента <span>Отрада</span> (<em>1156</em>) с получением данных за <span>1 день</span> в методе <code>\App\Classes\MDynamicsCRM\Synchronizers\V1\FromLk::handResync</code>.</p><h5 class="TypographyPresentation TypographyPresentation--colorDefault TypographyPresentation--h5 TypographyPresentation--fontWeightMedium RichText3-header2--withVSpacingNormal RichText3-header2"><span>Другие упоминания клиента </span><em><span>Отрада</span></em><span> (</span><em><span>ID</span></em><span> </span><em><span>1156</span></em><span>) в коде для кастомной логики</span></h5><p>Константа с <span>ID</span> клиента: <code>\App\Models\SCB\Client::OTRADA_CLIENT_ID = 1156</code>;</p><p>Для биллинга <span>UIS</span> с <span>М108</span>:<br /><code>\App\Classes\Billing\Uis\Helpers\RegistrationClients::UNIQUE_CLIENTS</code></p>