<ac:structured-macro ac:name="markdown" ac:schema-version="1" ac:macro-id="ad61ae4f-071a-433c-a008-febb42505554"><ac:plain-text-body><![CDATA[## Описание

Локальный сегмент - это сегмент, который настраивается нашим клиентом в личном кабинете. Настраивается он на основе
какого-нибудь показателя (метрики) клиента.

Функционал делится на две части: **_создание плана_** и **_сборка сегмента_**

### Создание плана.
Все планы находятся в таблице `segments_syncs_local_plan`.
План формируется на основе сегмента и количества дней, которые необходимо анализировать. Каждый день = 1 план.

>**Пример:** если мы создали сегмент с периодом 100 дней, то у нас создадутся 100 планов с периодом в 1 день.

>**Исключение:** Если же сегмент строится на основе когортного показателя
> (показатель у которого есть когортный фильтр), то нам нужно создать один план с указанным периодом.
> Т.е. при создании сегмента будет только 1 план с периодом 100 дней

Система создает планы в двух ситуациях:
1. При создании сегмента (см. `\App\Observers\SegmentObserver::$generatePlansForNewLocalSegmentUseCase`)
2. Ежедневный синхрон (см. `\App\Synchronizers\Stat\CDP\LocalSegmentsPlanGenerator` и в нем логику описывает - `\App\Classes\CDP\Synchronizers\LocalSegmentsPlanGenerator`)


### Cборка сегмента

Все результаты сборки хранятся в таблице `segments_persons_links`.

Базовая процедура сборки сегментов разбивается на 3 класса:
- `\App\Synchronizers\Stat\CDP\LocalSegmentsProcessing` - синхрон, который выполняется каждую минуту
- `\App\Classes\CDP\Synchronizers\LocalSegmentsProcessing` - логика получения планов и управление состоянием плана.
- `\App\Classes\CDP\UseCase\AnalyzeLocalSegmentUseCase` - логика сборки сегмента

Основная идея сборки сегмента заключается в том, что алгоритм использует модуль построителя.
Берется сегмент, дальне определяется, на какой показатель он настроен и просто запускает построитель. Дальше из результата
мы получаем OriginalData и вычленяем оттуда идентификаторы персон.

## Мониторинг

За работоспособностью модуля можно смотреть в [Grafana](http://grafana.smartis.bi/d/Nxek2oNVk/sborka-segmentov-segmentsprocessing?orgId=1&refresh=5m).
Можно наблюдать за работой синхронов по созданию и сборке планов, также смотреть состояние планов и логи работы.



]]></ac:plain-text-body></ac:structured-macro>