<h2><strong>Основное</strong></h2><p>Все данные изначально у нас находятся в облаке, после переносятся в коробку.</p><p>Перенос происходит раз в сутки, ночью, переносятся данные которые были <strong>Добавлены</strong> в прошлые сутки (<em>не с датой создания за прошлые сутки, а именно добавлены, тоесть может вчера был добален просмотр который создан месяц назад</em>).</p><p><br /></p><h2><strong>Как происходит перенос в коробку</strong></h2><p><strong><br /></strong>В коробках в кликхаусе создана дополнительная таблица views_cloud, так же создано прямое подключние к облаку через порт.</p><p>Ночью запускается синхрон&nbsp;BoxPostviewDataToLocalFromCloudSync который берет данные по нескольким условиям:</p><ol><li>Все данные которые были добавлены в прошлые сутки перенеслись, за это отвечает запись в settings created_at_from_postview_ИД_КЛИЕНТА, если это настройка пустая, то перенос возможен</li><li>Берется последний ver который был обработал, настройка box_last_view_ver_ИД_КЛИЕНТА (это доп защита, в случае если что-то ломалось и данные были не добавлены за ночь новые, на след запуск синхрона он возьмет не 1 сутки, а именно с даты последнего ver)</li><li>Перед переносом (если успешно прошел 1 пункт) чистятся все данные которые есть в таблице views_cloud по <strong>Клиенту</strong></li><li>Сам перенос</li><li>Когда всё перенеслось берется <strong>самая ранняя </strong>дата в таблице&nbsp;views_cloud и добавляется в настройку&nbsp;created_at_from_postview_ИД_КЛИЕНТА</li></ol><p><br /></p><h2><strong>Перенос внутри коробки</strong></h2><p><strong><br /></strong>Перенос внутри коробки идет через синхрон&nbsp;BoxPostviewDataFromCloudSync, он же использовался ранее когда тянули данные напрямую с облака.</p><p>Теперь синхрон работает получая данные из созданной таблицы&nbsp;views_cloud.</p><p>Изменены условия, ранее из облака данные тянулись по ver, сейчас внутри коробки данные берутся по created_at стартуя по записи&nbsp;created_at_from_postview_ИД_КЛИЕНТА и дергая за каждый час.</p><p>Так как ранее вместе с самими просмотрами мы дополняли ответ записями из smartis_ads, keyword и тд, эти данные дергаются из облака отдельно, собираются все айди ads, keyword и тд, и делаются запросы на получение.</p><p>По окончанию переноса запись в настройках&nbsp;created_at_from_postview_ИД_КЛИЕНТА очищяется, чтобы отработал новый забор данных, и запускается <strong>дедубликация</strong> данных.</p><p>Как синхрон понимает что данные закончились, есть настройка&nbsp;<span style="color: rgb(23,43,77);">created_at_to_postview_ИД_КЛИЕНТА, и простая проверка если&nbsp;created_at_from_postview_ИД_КЛИЕНТА &gt;&nbsp;created_at_to_postview_ИД_КЛИЕНТА.</span></p><p><span style="color: rgb(23,43,77);"><br /></span></p><h2><strong><span style="color: rgb(23,43,77);">Что по скорости</span></strong></h2><p><strong><span style="color: rgb(23,43,77);"><br /></span></strong><span style="color: rgb(23,43,77);">Ранее за один запуск синхрона ~500 сек. из облака переносилось в районе 150-200к записей.<br /></span></p><p><span style="color: rgb(23,43,77);">Сейчас за один такой запуск переносится в районе 1кк данных, с не важно насколько заполнена таблица&nbsp;views_cloud.</span></p><h2><strong>Что делать для перезабора исторических данных</strong></h2><p><strong>Важно! Проверяем есть ли место в коробке</strong></p><p>Первое идем в настройки и проверяем что&nbsp;created_at_from_postview_ИД_КЛИЕНТА пустая, иначе перезабор данных невозможен.</p><p>Так как мы не можем отследить ручной или нет запуск для переноса внутри облака, нужно запомнить, записать, скопировать, дату последнего ver, в настройках&nbsp;box_last_view_ver_ИД_КЛИЕНТА.</p><p>После чего запускам синхрон&nbsp;BoxPostviewDataToLocalFromCloudSync за нужные даты, ждём пока выполнится, перенос примерно 5кк записей в районе 5 минут.</p><p>Далее либо руками (увеличив допустим таймаут синхрона), либо добавление нового контейнера с запуском синхрона&nbsp;BoxPostviewDataFromCloudSync, переносим данные.</p><p>Примерное время 1кк за 5-6 минут.</p><p>После возвращаем&nbsp;box_last_view_ver_ИД_КЛИЕНТА которую запомнили ранее.</p><p><br /></p>