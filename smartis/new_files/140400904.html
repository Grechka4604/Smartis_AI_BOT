<h3>2021-11-10 10:16-10:19</h3><p>При отгрузке обновлений не запустились оба пода с nginx.</p><p>В событиях пода видим такую ситуацию:</p><table><colgroup><col /><col /><col /><col /><col /></colgroup><thead><tr><th><p>Type</p></th><th><p>Reason</p></th><th><p>Age</p></th><th><p>From</p></th><th><p>Message</p></th></tr></thead><thead><tr><th><p>Type</p></th><th><p>Reason</p></th><th><p>Age</p></th><th><p>From</p></th><th><p>Message</p></th></tr></thead><tbody><tr><td>Normal</td><td>Scheduled</td><td>34m</td><td>default-scheduler</td><td>Successfully assigned prod-my/nginx-8d8bdb95c-lxg5m to&nbsp;<a href="http://kuben2.sm/" rel="nofollow" class="external-link">kuben2.sm</a>.uis</td></tr><tr><td>Normal</td><td>Pulling</td><td>34m</td><td>kubelet</td><td>Pulling image &quot;<a class="external-link" rel="nofollow" href="http://registry.smartis.bi/smartis/my/nginx:develop-21-11-10-10-32">registry.smartis.bi/smartis/my/nginx:develop-21-11-10-10-32</a>&quot;</td></tr><tr><td>Normal</td><td>Pulled</td><td>34m</td><td>kubelet</td><td>Successfully pulled image &quot;<a class="external-link" href="http://registry.smartis.bi/smartis/my/nginx:develop-21-11-10-10-32" rel="nofollow">registry.smartis.bi/smartis/my/nginx:develop-21-11-10-10-32</a>&quot; in 34.462383664s</td></tr><tr><td>Normal</td><td>Created</td><td>33m</td><td>kubelet</td><td>Created container nginx</td></tr><tr><td>Normal</td><td>Started</td><td>33m</td><td>kubelet</td><td>Started container nginx</td></tr><tr><td>Warning</td><td>Unhealthy</td><td>2m46s (x3 over 2m56s)</td><td>kubelet</td><td>Liveness probe failed: Get &quot;<a class="external-link" href="http://10.244.2.65/nginx-health" rel="nofollow">http://10.244.2.65:80/nginx-health</a>&quot;: context deadline exceeded (Client.Timeout exceeded while awaiting headers)</td></tr><tr><td>Normal</td><td>Killing</td><td>2m46s</td><td>kubelet</td><td>Container nginx failed liveness probe, will be restarted</td></tr><tr><td>Warning</td><td>Unhealthy</td><td>81s (x21 over 2m56s)</td><td>kubelet</td><td>Readiness probe failed: Get &quot;<a class="external-link" rel="nofollow" href="http://10.244.2.65/nginx-health">http://10.244.2.65:80/nginx-health</a>&quot;: context deadline exceeded (Client.Timeout exceeded while awaiting headers)</td></tr></tbody></table><p>Т.е. понимаем, что не прошли Liveness &amp; Readiness пробы.</p><p>Их настройки:</p><table><colgroup><col /><col /></colgroup><tbody><tr><td>Liveness</td><td>http-get http://:80/nginx-health delay=1s timeout=1s period=5s #success=1 #failure=3</td></tr><tr><td>Readiness</td><td>http-get http://:80/nginx-health delay=1s timeout=1s period=5s #success=1 #failure=3</td></tr></tbody></table><p><br /></p><p>Получается, что nginx работал, но, в какой-то момент перестал отвечать.</p><p>По &quot;IP:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10.244.2.65&quot; понятно, что это kuben2</p><p>По &quot;Container ID:&nbsp;&nbsp;&nbsp;<a href="docker://5a8fec4f67e8f619563d1a1fddc5755abde7fd12649c0f03aa53e14142268abd" rel="nofollow">docker://5a8fec4f67e8f619563d1a1fddc5755abde7fd12649c0f03aa53e14142268abd</a>&quot; удалось найти логи в ноде по адресу</p><p>/var/lib/docker/containers/5a8fec4f67e8f619563d1a1fddc5755abde7fd12649c0f03aa53e14142268abd/5a8fec4f67e8f619563d1a1fddc5755abde7fd12649c0f03aa53e14142268abd-json.log</p><p>Весь лог не привожу, но привожу начальные строки</p><p>Из логов понятно, что контейнер функционировал нормально с 2021-11-10T07:45:07+00:00 по 2021-11-10T08:16:03+00:00. Сигнал на выключение поступил через 13 секунд после последней успешной попытки, а значит, контейнер, действительно, не работал 13 секунд.</p><p>Т.к. nginx запущен в alpine OS, логов, кроме тех, что указаны выше, у нас нет.</p><h4>Выводы</h4><p>Причину остановки nginx выяснить не удалось, но для диверсификации рисков будут предприняты следующие меры:</p><ol><li>Количество nginx приложений увеличено до трёх</li><li>Каждое приложение располагается на отдельном сервере</li><li>Установлены дополнительные&nbsp;<a class="external-link" href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/#specifying-a-poddisruptionbudget" rel="nofollow">параметры</a>, побуждающие kubernetes следить за тем, чтобы хотя бы один контейнер с nginx всегда был запущен.</li></ol>