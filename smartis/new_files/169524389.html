<ac:structured-macro ac:name="markdown" ac:schema-version="1" ac:macro-id="453482c2-cf17-4b94-b389-63cf88642290"><ac:plain-text-body><![CDATA[[Инструкция по подключению и по логике работы со стороны клиента](https://docs.uiscom.ru/pages/viewpage.action?pageId=161846522)


На 2023-09-21 работает только для клиента Капитал (1875)

Если вкратце - основная задача минусации отминусовать сегменты, собранные у нас, из рекламных кампаний
в рекламном кабинете.

## Настройки минусации

В минусации можно выбрать сегменты и настроить рекламные кабинеты.

Сегменты участвующие в решении хранятся в таблице `segments_cdp_solutions` с фильтром `solution_code=minusation`.

Настройки по минусации хранятся в таблице `segments_cdp_solutions_services` с фильтром `solution_code=minusation`. В колонке
settings_json хранится информация о том в каких рекламных кампаниях в рамках каких аккаунтов надо минусовать сегменты.
Структура настройки описана в класс `\App\Classes\CDP\Solutions\Settings\Entities\AdvAccount`.


## Алгоритм работы

Минусация отрабатывает ежечасно, инициируется в `\App\Synchronizers\Stat\CDP\LaunchMinusationSync`

Он внутри себя запускает единый UseCase для запуска решений - `\App\Classes\CDP\UseCase\LaunchSolutionUseCase`

Далее через общие алгоритмы работы решений все переходит в зону работы класса `\App\Classes\CDP\Solutions\Strategies\AdvAccountsLauncherStrategy`.
Данный класс начинает работать с подключенными сегментами и пробегается по настроенным аккаунтам и для них начинает 
применять правило минусации в настроенных рекламных кампаниях. Для каждого логина запускается процесс общения по API с рекламным кабинетом.
Для Яндекс.Директ алгоритм переходит в класс `\App\Classes\CDP\Solutions\Algorithms\YDirectMinusationAlgorithm`

## Мониторинг

За работоспособностью модуля можно смотреть в [Grafana](http://grafana.smartis.bi/d/_icrfEA4z/minusatsiia?orgId=1).
Можно увидеть подключенных клиентов, работу синхрона и логи ошибок.
>**Примечание.** Текущий алгоритм минусации не учитывает ситуации, когда клиент на своей стороне копирует рекламные кампании на основе существующих. Поэтому
> мы натыкаемся на ошибку:
> ```
> -- Для кампании #87638418 не получилось создать корректировку - This retargeting list already exists in the group, Для кампании #91487493 не получилось создать корректировку - This retargeting list already exists in the group, Для кампании #91487499 не получилось создать корректировку - This retargeting list already exists in the group, Для кампании #91487542 не получилось создать корректировку - This retargeting list already exists in the group, Для кампании #91487552 не получилось создать корректировку - This retargeting list already exists in the group, Для кампании #91487567 не получилось создать корректировку - This retargeting list already exists in the group
> -- Ошибка API: Ошибка удаления RetargetingList {"login":"moscowresidences@yandex.ru","id":15064437,"errors":[{"Code":8301,"Message":"Not possible to delete object","Details":"Not possible to delete object: 15064437"}],"warnings":[]}
> ```
> На это не стоит обращать внимание!


]]></ac:plain-text-body></ac:structured-macro>