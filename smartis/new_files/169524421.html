<ac:structured-macro ac:name="markdown" ac:schema-version="1" ac:macro-id="b221296e-0f8d-46f6-aef1-cb3455925ea1"><ac:plain-text-body><![CDATA[Антифрод - скоринг обращений на определение % фрода.


## Подключение

Антифрод подключается через раздел "Готовые решения". 
Алгоритм подключения через интерфейс:
1. Обработка общим контроллером - `\App\Http\Controllers\Lk\Stat\CdpSolutionsAjaxController::connectSolution`.
2. UseCase подключения решения - `\App\Classes\CDP\UseCase\ConnectCdpSolutionUseCase`.
3. Логика подключения антифрода - `\App\Classes\CDP\Solutions\Strategies\AntiFraudConnectorStrategy`

## Скоринг

Скоринг происходит автоматически, синхрон `\App\Synchronizers\Stat\Fraud\RealTimeSync` выполняется каждую ночь и 
анализирует обращения за последние 30 дней.

Для запуска скоринга используется сервис -  `\App\Classes\CDP\Solutions\Algorithms\Antifraud\RealTimeSync\RealTimeSyncHandler`.
У него доступны методы для различного запуска скоринга. Скоринг можно запустить, как для `requests`, так и для `crm_elements`.
```php
public function handle(RealTimeSyncInputDto $dto): void
public function syncItems(int $clientId, array $itemsIds, FraudStrategyInterface $strategy): void
public function syncRequest(int $clientId, int $requestId): void
public function syncCrmElement(int $clientId, int $crmElementId): void
```

Далее общий принцип работы скоринга:

   **1.** Берем строки из `requests`/`crm_elements` и по 500 элементов начинаем их скорить

**2.** Передаем пакет сущностей на скоринг в `\App\Classes\CDP\Solutions\Algorithms\Antifraud\RealTimeAnalyze\RealTimeAnalyzeHandler::handle` 
> В начале происходит обработка входного пакета и получение механик, через которые нужно прогнать обращения.
> Общий список механик описан в `\App\Providers\Modules\FraudServiceProvider::register`, но для каждого типа данных, может использоваться
> свой набор механик и конечный список определяется в методе интерфейса `\App\Classes\CDP\Solutions\Algorithms\Antifraud\Strategies\FraudStrategyInterface::getMechanics`.
> 
> Далее мы анализируем пакет сущностей на механику, с помощью сервиса `\App\Services\Fraud\FraudAnalyzeService`.
> 
> **ВАЖНО.** Все механики находятся в папке `app/Classes/CDP/Solutions/Algorithms/Antifraud/Strategies/RealTimeFraudAnalyze`.
> Все что написано в phpdoc - является истиной и при любом изменении логики необходимо актуализировать информацию!
>

**3.** Фиксируем результаты скоринга в таблицы и сохраняем логи

## База данных

Список используемых таблиц:

`fraud_analyze_client_logs` - таблица логов работы скоринга обращений по клиентам

`fraud_analyze_conditions` - таблица поддерживаемых механик (в будущем лучше избавиться от нее и перейти на описание массива на бэке)

`fraud_analyze_strategy_logs` - таблица логов с результатом работы скоринга обращений по стратегиям

`fraud_crm_element_history` - результаты скоринга `crm_elements` по механикам

`fraud_crm_element_percent` - общий результат скоринга `crm_elements`

`fraud_requests_history` - результаты скоринга `requests` по механикам

`fraud_requests_percent` - общий результат скоринга `requests`


## Мониторинг
За работоспособностью модуля можно смотреть в [Grafana](http://grafana.smartis.bi/d/PX2p8pc4z/antifraud?orgId=1).
Можно увидеть подключенных клиентов, работу синхрона, логи ошибок и объемы проскоренных обращений.


]]></ac:plain-text-body></ac:structured-macro>