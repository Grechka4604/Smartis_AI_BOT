<h2>Достоверность</h2><ac:structured-macro ac:name="markdown" ac:schema-version="1" ac:macro-id="7ce9f26b-c8b1-4662-82c6-fa4589f907e5"><ac:plain-text-body><![CDATA[- **Общая информация**
    - Основной синхрон: #65 `\App\Synchronizers\Stat\Accuracy\DailySync`
    - Оперирует двумя таблицами: `accuracy_plan` & `accuracy_itogs`
    - Работает только для клиентов аналитики (`clients.is_analysis_client`)
    - Всегда создается джоба `\App\Jobs\AccuracyJob`
    - Считаем доствоерность только для сервисов, которые перечислены `\App\Models\Stat\Service::ACCURACY_SERVICES`
    - Вся достоверность наследуется от базового класса `\App\Classes\BaseAccuracy`
       - достоверность анализа не наследуется
       - достоверность демо кабинета не наследуется
    - Обработка ошибок:
       - Ошибки должны заполняться в колонку `accuracy_plan.errors`
       - Есть свои спец ошибки, которые обрабатываются по особому. Находятся в директори `my/app/Classes/Accuracy/Exceptions`
       - Логика обработки спец ошибок находится в джобе. Например есть ошибка `RetryJobLaterException`. При ней мы будем повторять попытку обработать джобу через 15 минут НЕ прибавляя attempts
    - За джобами следит спец синхрон `\App\Synchronizers\Stat\Accuracy\JobController`
    - Для тестирования используй статичный запуск синхрона (опция `--static`)


- **Принципы подготовки параметров для запуска джоб**
    - Важная логика создания массива клиентов / сервисов находится в методе `\App\Synchronizers\Stat\Accuracy\DailySync::getDataForRun`. Там же находится спец логика для некоторых клиентов и сервиса анализа.
    - Можно запустить джобу достоверности сразу за несколько дней в прошлое.
    - Метод `\App\Synchronizers\Stat\Accuracy\DailySync::getDaysInPastForService` определяет возможность обработки периода в рамках одной джобы. Определяется интерфейсом, который навешивается на класс `Core` требуемого сервиса
    - Мы так же всегда пересчитываем достоверность для плохих результатов. Метод: `\App\Synchronizers\Stat\Accuracy\DailySync::remakeAccuracyWithBadPercent`
- **Принципы расчета достоверности**
    - В большинстве сервисов расчет происходит вида `$this→countLeads` | `$this→countContacts`
      Эта логика позволяет сразу немного разделять все на мелкие методы, что позволит в дальнейшем при изменении логики
    - Есть 3 сервиса, которые работают через интерфейсы
       - Дайнемикс (вынуждено)
       - 1с (вынуждено)
       - Комеджик (первая и последняя попытка перевода достоверности на логику интерфейсов)
    - Есть различный набор методов для фиксирования результатов и расчета процента. Находятся в самой модельке `\App\Models\Stat\AccuracyItog`
    - Принципы получения информации из апи
       - Обычно используется напрямую класс Api и конкретные методы. 
       - В сервисах, использующих интерфейсы, вместо вызова класса Api происходит по сути запуск синхрона, но с выдачей информацией. Это позволяет:
          - Упростить разработку
          - Упростить добавление новых методов

   
- **Grafana**
    - дашборд доствоерности http://grafana.smartis.bi/d/DEYk2B87k/dostovernost?orgId=1

## Ручные операции

- **Общие принципы**
    - Место: `/my/app/Classes/HandOperation`
    - Таблица: `hand_operations`
    - При создании новых операций проверяется дубликация
    - Создан специальный конфигурационный файл `config\hand-operations.php`
      В нем содержится информация, на основе которой
       - ПМ-ы будут выбирать какие сущности обновлять
       - Синхрон будет работать и принимать важные решения (точнее одно решение: считать достоверность или нет)
    - Есть логика интерфейсов. Работает в дайнемиксе и 1с
    - Запускается джоба `\App\Classes\HandOperation\Jobs\HandOperationJob`
    - Есть команды:
       - Для тестирования плохой джобы: `\App\Console\Commands\HandOperationSyncCommand`
          - найти проблемный айдишник из табл hand_operations
          - запустить команду hand:operation:static --id=?
          - в самой джобе ручных операций закоментить первые строки, делающие проверку на статус джобы и на количество попыток
       - Для создания массовых джоб обновления с бека: `\App\Console\Commands\HandOperationCreationCommand`
          
    - Вывод информации на фронт:
       - Выводятся записи, которые не просмотрены (колонка `is_seen`)
       - Записи можно скрыть, щелкнув по ним
       - ЯД выводится по-особому. В первую очередь связано с тем, что у него свои джобы + изначально было реализовано по другому



## **Страница “Мониторинг системы”**

- **Общие принципы**
    - Таблица показывается по принципу “все имеющиеся данные + все активные интеграции”. Что имеется в виду:
       - Если интеграцию удалили, данные не показываем.
       - Если интеграция в архиве, она отображается в списке интеграций
       - Если интеграция новая, то данных еще быть не может, будет показана пустая строка самой интеграции. Это важно для внедрения изза доступа к кнопке обновления
    - В `accuracy_itogs` есть флаг `is_developing`. Если `true`, то эта достоверность показываться не будет
    - У сервиса анализа (35) нет интеграций, как следствие там используется затычка
- **Бэк**
    - Директория `/app/Classes/SystemMonitoring`
    - в Blocks находится компоненты наполнения детализации. Они никак не взаимодействуют друг с другом
    - Основной класс заполнения таблицы: `\App\Classes\SystemMonitoring\Table\AccuracyItogsTableCreator`. Код сложен, увы, но в примерно начале класса приведен пример готового массива
- **Фронт**
    - Таблица не строится за период больше 180 дней. Клиент увидет уведомление
    - Колонки можно растягивать
    - Все ячейки (кроме строки заголовка) прокликиваются. Откывается *детализация*
    - Сами ячейки могут обновляться (будет спиннер). Если у интеграции проблемы - она будет красной. Это определяется спец флагами, которые передаются с бека
    - Детализация состоит из блоков, они отрисовывются **асинхронно**
    - Детализированное окно закрывается нажатием `esc` (user-friendly for PC users)
    - При клике на сервис / интеграцию есть интересный блок “спец информации”. Сейчас он используется только у комеджика
    - При открытии загружается моделька интеграции используя общий компонент инеграций. С этим могут быть проблемы.


  Написан readme `my/resources/assets/js/components/pages/sm-admin/monitoring/README.MD`
  В нем перечислены основные нюансы кода и советы по добавлении нового блока


]]></ac:plain-text-body></ac:structured-macro>